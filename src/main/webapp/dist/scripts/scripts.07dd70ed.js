"use strict";angular.module("ecommApp",["LocalStorageModule","ui.router","ngResource"]).run(["$rootScope","$state","Auth","Principal",function(a,b,c,d){a.$on("$stateChangeStart",function(b,e,f){a.toState=e,a.toStateParams=f,d.isIdentityResolved()&&(console.log("Principal.isIdentityResolved(): "+d.isIdentityResolved()),c.authorize())}),a.$on("$stateChangeSuccess",function(b,c,d,e,f){a.previousStateName=e.name,a.previousStateParams=f})}]).factory("authInterceptor",["localStorageService",function(a){return{request:function(b){b.headers=b.headers||{};var c=a.get("token");return console.log("reqest:config"),console.log(c),c&&c.expires&&c.expires>(new Date).getTime()&&(b.headers["x-auth-token"]=c.token),b}}}]).config(["$httpProvider","$stateProvider","$urlRouterProvider",function(a,b,c){a.interceptors.push("authInterceptor"),c.otherwise("/register"),b.state("home",{url:"/home",templateUrl:"views/home.html"}).state("register",{url:"/register",templateUrl:"views/register.html",controller:"RegisterController"}).state("login",{url:"/login",templateUrl:"views/login.html",controller:"LoginController"}).state("logout",{url:"/logout",templateUrl:"views/login.html",controller:"LogoutController"})}]),angular.module("ecommApp").controller("AccountController",["$scope","$state","Register","Auth"]),angular.module("ecommApp").controller("LoginController",["$rootScope","$scope","$state","$timeout","Auth",function(a,b,c,d,e){b.user={username:"cook1fan",password:"kuangde43"},b.errors={},b.login=function(){e.login(b.user).then(function(){b.authenticationError=!1,c.go("home")})["catch"](function(){b.authenticationError=!0})}}]),angular.module("ecommApp").controller("LogoutController",["Auth",function(a){a.logout()}]),angular.module("ecommApp").controller("NavbarController",["$scope","$location","$state","Auth","Principal",function(a,b,c,d,e){a.isAuthenticated=e.isAuthenticated,a.$state=c,a.logout=function(){d.logout(),c.go("home")}}]),angular.module("ecommApp").controller("RegisterController",["$scope","Auth",function(a,b){a.user={username:"cook1fan",password:"kuangde43",email:"32582048@qq.com"},a.register=function(){console.log(a.user),b.createAccount(a.user).then(function(){a.success="OK"})["catch"](function(a){console.log(a)})}}]),angular.module("ecommApp").factory("Account",["$resource",function(a){return a("api/account",{},{get:{method:"GET",params:{},isArray:!1,interceptor:{response:function(a){return a}}}})}]),angular.module("ecommApp").factory("Auth",["$rootScope","$state","$q","Principal","AuthServerProvider","Register",function(a,b,c,d,e,f){return{login:function(a,b){var f=b||angular.noop,g=c.defer();return e.login(a).then(function(a){return d.identity(!0).then(function(){g.resolve(a)}),f()})["catch"](function(a){return this.logout(),g.reject(a),f(a)}.bind(this)),g.promise},logout:function(){e.logout(),d.authenticate(null)},authorize:function(a){return d.identity(a).then(function(){})},createAccount:function(a,b){var c=b||angular.noop;return f.save(a,function(){return c(a)},function(a){return this.logout(),c(a)}.bind(this)).$promise}}}]),angular.module("ecommApp").factory("AuthServerProvider",["$http","localStorageService",function(a,b){return{login:function(c){var d="username="+c.username+"&password="+c.password;return a.post("api/authenticate",d,{headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"}}).success(function(a){return console.log("token:"),console.log(a),b.set("token",a),a})},logout:function(){b.clearAll()},getToken:function(){return b.get("token")},hasValidToken:function(){var a=this.getToken();return a&&a.expires&&a.expires>(new Date).getTime()}}}]),angular.module("ecommApp").factory("Principal",["$q","Account",function(a,b){var c,d=!1;return{isIdentityResolved:function(){return angular.isDefined(c)},isAuthenticated:function(){return d},isInRole:function(a){return d&&c&&c.roles?-1!==c.roles.indexOf(a):!1},isInAnyRole:function(a){if(!d||!c.roles)return!1;for(var b=0;b<a.length;b++)if(this.isInRole(a[b]))return!0;return!1},authenticate:function(a){c=a,d=null!==a},identity:function(e){var f=a.defer();return e===!0&&(c=void 0),angular.isDefined(c)?(f.resolve(c),f.promise):(b.get().$promise.then(function(a){c=a.data,d=!0,f.resolve(c)})["catch"](function(){c=null,d=!1,f.resolve(c)}),f.promise)}}}]),angular.module("ecommApp").factory("Register",["$resource",function(a){return a("/api/register",{},{})}]);